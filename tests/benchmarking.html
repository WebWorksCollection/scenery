<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Benchmarking</title>

  <!-- jQuery and LoDash are dependencies -->
  <script src="../../sherpa/lib/jquery-2.1.0.min.js"></script>
  <script src="../../sherpa/lib/lodash-4.17.4.min.js"></script>

  <script src="../../assert/js/assert.js"></script>
  <script src="../../tandem/js/PhetioIDUtils.js"></script>
  <script src="../../sherpa/lib/himalaya-0.2.7.js"></script>
  <script src="../../sherpa/lib/he-1.1.1.js"></script>
  <script src="../../sherpa/lib/benchmark-2.1.4.js"></script>

  <script type="text/javascript">
    window.assertions.enableAssert();
    window.assertions.enableAssertSlow();
  </script>
</head>
<body>

<script type="module">
  import scenery from '../js/main.js';
  import phetCore from '../../phet-core/js/main.js';
  import axon from '../../axon/js/main.js';
  import dot from '../../dot/js/main.js';
  import kite from '../../kite/js/main.js';
  import utteranceQueue from '../../utterance-queue/js/main.js';

  import AxonArray from '../../axon/js/AxonArray.js';
  import ObservableArray from '../../axon/js/ObservableArray.js';

  window.scenery = scenery;
  window.kite = kite;
  window.dot = dot;
  window.phetCore = phetCore;
  window.axon = axon;
  window.utteranceQueue = utteranceQueue;

  console.log( 'loaded' );

  const suite = new Benchmark.Suite;

  let array;
  let observableArray;
  let axonArray;
  let counter = 0;

  function pureActions( array ) {
    for ( let i = 0; i < 1000; i++ ) {
      array.push( i );
    }
    for ( let i = 0; i < 500; i++ ) {
      if ( _.some( array, x => x === i ) ) {
        counter++;
      }
    }
    while ( array.length ) {
      array.pop();
    }
  }
  function impureActions( array ) {
    for ( let i = 0; i < 1000; i++ ) {
      array.push( i );
    }
    for ( let i = 0; i < 500; i++ ) {
      if ( _.some( array, x => x === i ) ) {
        counter++;
      }
    }
    while ( array.length ) {
      array.pop();
    }
  }

  for ( let i = 0; i < 6; i++ ) {
    pureActions( [] );
    impureActions( new AxonArray() );
  }

  /*
  var arr = new axon.AxonArray();
  arr.addItemAddedListener( item => console.log( `add ${item}` ) );
  arr.addItemRemovedListener( item => console.log( `remove ${item}` ) );
  arr.push( 1, 2, 3 );
  _.remove( arr, x => x === 2 );
  _.pull( arr, 3 );

  Object.keys( arr )
  */

  suite.add( 'Creation#Array', () => {
    array = [];
  } );
  suite.add( 'Creation#ObservableArray', () => {
    observableArray = new ObservableArray();
  } );
  suite.add( 'Creation#AxonArray', () => {
    axonArray = new AxonArray();
  } );

  suite.add( 'AssortedActions#Array', () => {
    array = [];
    for ( let i = 0; i < 1000; i++ ) {
      array.push( i );
    }
    for ( let i = 0; i < 500; i++ ) {
      if ( _.some( array, x => x === i ) ) {
        counter++;
      }
    }
    while ( array.length ) {
      array.pop();
    }
  } );
  suite.add( 'AssortedActions#ObservableArray', () => {
    observableArray = new ObservableArray();
    observableArray.addItemAddedListener( () => {} );
    observableArray.addItemRemovedListener( () => {} );
    for ( let i = 0; i < 1000; i++ ) {
      observableArray.push( i );
    }
    for ( let i = 0; i < 500; i++ ) {
      if ( observableArray.some( x => x === i ) ) {
        counter++;
      }
    }
    while ( observableArray.length ) {
      observableArray.pop();
    }
  } );
  suite.add( 'AssortedActions#AxonArray', () => {
    axonArray = new AxonArray();
    axonArray.addItemAddedListener( () => {} );
    axonArray.addItemRemovedListener( () => {} );
    for ( let i = 0; i < 1000; i++ ) {
      axonArray.push( i );
    }
    for ( let i = 0; i < 500; i++ ) {
      if ( _.some( axonArray, x => x === i ) ) {
        counter++;
      }
    }
    while ( axonArray.length ) {
      axonArray.pop();
    }
  } );


  suite.add( 'Deopt#pure', () => {
    pureActions( [] );
  } );
  suite.add( 'Deopt#impure', () => {
    impureActions( [] );
  } );


  suite.on( 'cycle', event => {
    console.log( String( event.target ) );
  } );

  suite.on('complete', function() {
    console.log( 'Complete' );
  } );

  suite.run( { 'async': true } );
</script>
</body>
</html>
